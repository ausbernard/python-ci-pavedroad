name: Python Deploy NP

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: python-deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.10"
  IMAGE_NAME: ghcr.io/${{ github.repository }}

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tags: ${{ steps.meta.outputs.tags }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Compute next version
      id: semver
      uses: paulhatch/semantic-version@v5.4.0
      with:
        tag_prefix: "v"
        version_format: "${major}.${minor}.${patch}"
        major_pattern: "BREAKING CHANGE"
        minor_pattern: "^feat:"
        search_commit_body: true
        bump_each_commit: false


  #     - name: Docker meta
  #       id: meta
  #       uses: docker/metadata-action@v5
  #       with:
  #         images: ${{ env.IMAGE_NAME }}
  #         tags: |
  #           type=ref,event=pr
  #           type=raw,value=v${{ steps.version.outputs.version }}
  #           type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

  # lint-test:
  #   name: Lint and Test
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4

  #     - uses: actions/setup-python@v6
  #       with:
  #         python-version: ${{ env.PYTHON_VERSION }}
  #         cache: "pip"

  #     - name: Install and Test
  #       run: |
  #         python -m pip install --upgrade pip
  #         pip install -e ".[dev]"
  #         pre-commit run --all-files
  #         pytest -v --cov=src --cov-report=term-missing

  # build-image:
  #   name: Build and Push
  #   needs: [lint-test, version]
  #   runs-on: ubuntu-latest
  #   permissions:
  #     contents: read
  #     packages: write
  #   steps:
  #     - uses: actions/checkout@v4

  #     - uses: docker/setup-buildx-action@v3

  #     - uses: docker/login-action@v3
  #       if: github.event_name == 'pull_request'
  #       with:
  #         registry: ghcr.io
  #         username: ${{ github.actor }}
  #         password: ${{ secrets.GITHUB_TOKEN }}

  #     - name: Build and Push
  #       uses: docker/build-push-action@v6
  #       with:
  #         context: .
  #         push: ${{ github.event_name == 'pull_request' }}
  #         tags: ${{ needs.version.outputs.tags }}
  #         cache-from: type=gha
  #         cache-to: type=gha,mode=max
